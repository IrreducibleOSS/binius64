name: CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: ${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  format:
    name: format
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Check copyright
        uses: pre-commit/action@v3.0.1
        with:
          extra_args: copyright --all-files
      - name: Check typos
        uses: pre-commit/action@v3.0.1
        with:
          extra_args: typos --all-files
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt
      - name: Install nightly toolchain for rustfmt
        run: rustup toolchain install nightly-2025-08-11 --component rustfmt
      - name: Check rustfmt
        uses: pre-commit/action@v3.0.1
        with:
          extra_args: rustfmt --all-files

  rust-checks:
    strategy:
      fail-fast: false
      matrix:
        arch:
          - name: x86_64-portable
            runner: ubuntu-24.04
            rustflags: # portable
          - name: x86_64
            runner: ubuntu-24.04
            rustflags: "-Ctarget-cpu=native"
          - name: arm64
            runner: ubuntu-24.04-arm
            rustflags: "-Ctarget-cpu=native"
    name: rust-checks-${{ matrix.arch.name }}
    runs-on: ${{ matrix.arch.runner }}
    env:
      RUSTFLAGS: ${{ matrix.arch.rustflags }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy
      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest
      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ matrix.arch.name }}-cargo-${{ hashFiles('**/Cargo.toml') }}
      - name: Run platform diagnostics
        run: cargo test -p binius-utils --features platform-diagnostics test_platform_diagnostics -- --nocapture
      - name: Run clippy
        run: cargo clippy --workspace --all-targets -- -D warnings
      - name: Run tests
        run: cargo nextest run --workspace --no-fail-fast
      # Must run doctests separately, see https://github.com/nextest-rs/nextest/issues/16
      - name: Run doctests
        run: cargo test --doc --workspace

  rust-tests:
    name: rust-${{ matrix.test.name }}-${{ matrix.machine.name }}
    runs-on: ${{ matrix.machine.runner }}
    # Skip draft PRs to save costs, except for Graphite merge queue PRs (branch prefix: gtmq_)
    # Graphite MQ docs: https://graphite.dev/docs/graphite-merge-queue
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || startsWith(github.head_ref, 'gtmq_')
    strategy:
      fail-fast: false
      matrix:
        machine:
          - runner: "m8g-2xlarge"
            name: "arm64"
          - runner: "m7i-2xlarge"
            name: "x86_64"
        test:
          - name: "test-all-features"
            command: |
              ALL_FEATURES_WO_BAIL_PANIC=$(.github/scripts/get-features-without-bail-panic.sh | tail -1)
              echo "ALL_FEATURES_WO_BAIL_PANIC: $ALL_FEATURES_WO_BAIL_PANIC"
              cargo nextest run --workspace --release --features "$ALL_FEATURES_WO_BAIL_PANIC" --no-fail-fast
            rustflags: "-C debug-assertions -C target-cpu=native"
          # Build against wasm32-unknown-unknown target to that our libraries compile to wasm.
          - name: "vanilla-wasm32"
            command: |
              cargo build -p binius-prover -p binius-verifier
            rust-target: "wasm32-unknown-unknown"
          - name: "wasm32-wasip1"
            command: |
              cargo build -p binius-math -p binius-field -p binius-prover -p binius-verifier --target wasm32-wasip1 --tests --benches
              cargo test -p binius-math -p binius-field -p binius-prover -p binius-verifier --target wasm32-wasip1 --config "target.'cfg(all())'.runner=['wasmer']"
            rust-target: "wasm32-wasip1"
        # Exclude wasm targets on ARM64 as the host architecture doesn't affect the results
        exclude:
          - machine:
              name: "arm64"
            test:
              name: "vanilla-wasm32"
          - machine:
              name: "arm64"
            test:
              name: "wasm32-wasip1"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Install deps
        run: sudo yum -y install gcc openssl-devel curl jq z3-devel clang pkg-config
      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.test.rust-target || '' }}
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.machine.name }}-${{ matrix.test.name }}
          cache-on-failure: true
      - name: Run platform diagnostics
        run: cargo test -p binius-utils --features platform-diagnostics test_platform_diagnostics -- --nocapture
      - name: Run platform diagnostics (target-cpu=native)
        run: cargo test -p binius-utils --features platform-diagnostics test_platform_diagnostics -- --nocapture
        env:
          RUSTFLAGS: "-C target-cpu=native"
      - name: Set up Wasmer
        uses: wasmerio/setup-wasmer@v2
        with:
          version: 'v6.0.1'
      - name: Run command
        run: ${{ matrix.test.command }}
        env:
          RUSTFLAGS: ${{ matrix.test.rustflags || '' }}
          # Seems like z3-devel pkg-config config is broken and has wrong path to include files.
          # This was fixed upstream but the fix seems to be not available in the present CI
          # environment. Therefore, we workaround this by overriding the env flags manually.
          Z3_SYS_Z3_HEADER: /usr/include/z3/z3.h
          CFLAGS: -I/usr/include/z3
          LDFLAGS: -L/usr/lib64 -lz3

  rust-doc:
    name: rust-doc
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Build documentation (including private items for CI checks)
        run: cargo doc --document-private-items --no-deps

  circuits-snapshot:
    name: circuits-snapshot (${{ matrix.example }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        example: [ethsign, zklogin, sha256, sha512, keccak, blake2s, hashsign]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Check ${{ matrix.example }} circuit statistics snapshot
        run: cargo run --example ${{ matrix.example }} -- check-snapshot

  # This job ensures all CI checks pass
  ci-all-checks:
    runs-on: ubuntu-latest
    # Run if: dependencies succeeded OR it's a Graphite MQ PR (even with skipped deps)
    # This ensures Graphite MQ can't merge with skipped tests
    if: success() || startsWith(github.head_ref, 'gtmq_')
    needs:
      - format
      - rust-checks
      - rust-tests
      - rust-doc
      - circuits-snapshot
    steps:
      - name: Verify all jobs succeeded
        run: |
          set -e  # Exit immediately if any command fails

          echo "Job results:"
          echo "format: ${{ needs.format.result }}"
          echo "rust-checks: ${{ needs.rust-checks.result }}"
          echo "rust-tests: ${{ needs.rust-tests.result }}"
          echo "rust-doc: ${{ needs.rust-doc.result }}"
          echo "circuits-snapshot: ${{ needs.circuits-snapshot.result }}"
          echo ""

          echo "Job results (JSON):"
          echo '${{ toJson(needs) }}' | jq .
          echo ""

          echo "Verifying all jobs actually ran and succeeded..."

          # note:
          # - 'all(...)' returns true only if the condition is true for ALL items
          # - '--exit-status' makes jq exit with code 1 if the check fails (causing job to fail)
          jq --exit-status 'all(.result == "success")' <<< '${{ toJson(needs) }}'

          echo "âœ… All CI checks passed successfully"
